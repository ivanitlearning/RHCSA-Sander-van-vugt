# EX342
Notes from Sander van vugt's EX342 course

# 1. Troubleshooting basics
Show journald messages for specific unit `journalctl -u service.unit`

Show messages with priority between emergency and error  `journalctl -p emerg..err` 

Show messages in specific interval `journalctl --since 2012-10-30 18:17:16 --until 2012-10-30 20:17:16`

Make journald logging persistent by creating /var/log/journal and setting SGID.

Note: If SELinux is not logging some violations (such as FTP writes) you might have to [turn it on](https://serverfault.com/a/545279/455579) with `semodule --disable_dontaudit --build`

# 2. Systems Monitoring

## 2.1 cockpit

Install package **cockpit**, then include exception in firewall-cmd. Login with root.

## 2.2 Performance co-pilot (PCP)

Install packages `pcp` and `pcp-system-tools` or the yum group Performance Tools.

Check service `pmcd.service` is running

Show performance with `pcp atop`

Documentation is in `pcp-doc` package, start with `man pcpintro`

Can view historical logging with `pmval` such as `pmval -a /var/log/pcp/pmlogger/rhcsa1.example.com/20221011.16.10.0 kernel.all.load`

## 2.3 Logging overview

rsyslog logs to /var/log with specified priority and facility.

rsyslog doesn't capture everything, the rest goes to systemd-journald

rsyslog offers remote logging

## 2.4 rsyslog remote logging

On rsyslog server:
1. Edit /etc/rsyslog.conf to uncomment these lines for TCP
  ```text
  module(load="imtcp") # needs to be done just once
  input(type="imtcp" port="514")
  ```
2. Add service or port exception to firewall-cmd
3. 

On rsyslog client:
1. Uncomment this line in rsyslog.conf
  ```text
  # remote_host is: name/ip, e.g. 192.168.0.1, port optional e.g. 10514
  #Target="remote_host" Port="XXX" Protocol="tcp")
  ```
2. Restart rsyslog.service

## 2.5 systems monitoring

Check what config files have changed from installation package with `rpm -Va`. Refer to `man rpm` for details.

Alternatively one can use AIDE

## 2.6 Configuring AIDE

* Advanced Intrusion Detection Environment (AIDE)
* Used to track changes to specified files

Install package `aide`

Config file in **/etc/aide.conf**

Steps to use:

1. Initialise DB with `aide --init`. Note location is specified in **/etc/aide.conf**. (This will take several min)
2. Rename database to **aide.db.gz** or you'll get this error
> Couldn't open file /var/lib/aide/aide.db.gz for reading
3. Make changes to monitored files
4. Run `aide --check` to list changes tracked.

